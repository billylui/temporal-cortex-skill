# Release workflow — creates a GitHub Release when a v* tag is pushed.
#
# Trigger: push a version tag (e.g., git tag v0.5.1 && git push origin v0.5.1)
#
# Jobs:
#   1. validate — run all CI checks (SKILL.md, scripts, JSON, links)
#   2. release  — create GitHub Release with CHANGELOG summary

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate all SKILL.md files
        run: bash tests/validate-skill.sh

      - name: Validate multi-skill structure
        run: bash tests/validate-structure.sh

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: scripts

      - name: Validate JSON
        run: |
          for f in assets/presets/*.json .mcp.json; do
            echo "Validating: $f"
            JSON_FILE="$f" python3 -c "import json, os; json.load(open(os.environ['JSON_FILE']))" || exit 1
          done

      - name: Check version consistency
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          # Check router skill version matches tag
          SKILL_VERSION=$(grep -oP 'version:\s*"\K[^"]+' skills/temporal-cortex/SKILL.md)
          if [ "$TAG_VERSION" != "$SKILL_VERSION" ]; then
            echo "ERROR: Tag version ($TAG_VERSION) does not match router SKILL.md version ($SKILL_VERSION)"
            exit 1
          fi
          # Check all sub-skills match
          for skill_md in skills/*/SKILL.md; do
            SUB_VERSION=$(grep -oP 'version:\s*"\K[^"]+' "$skill_md")
            if [ "$TAG_VERSION" != "$SUB_VERSION" ]; then
              echo "ERROR: Tag version ($TAG_VERSION) does not match $(basename $(dirname $skill_md)) version ($SUB_VERSION)"
              exit 1
            fi
          done
          echo "Version $TAG_VERSION matches all SKILL.md files"

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BODY=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          echo "$BODY" > /tmp/release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release create "$GITHUB_REF_NAME" \
            --title "Agent Skills v${VERSION}" \
            --notes-file /tmp/release-notes.md
